<h1 align="center">v4 索引器</h1>

这个单体仓库包含用于部署 V4 索引器的一组包和服务。

V4 索引器是一组微服务，为 dYdX V4 应用程序提供丰富的 API 和 WebSocket 通道。

组成 V4 索引器的服务包括：
- ender：通过 Kafka 从 V4 节点接收链上事件，将它们归档到 PostgreSQL 数据库，并将链上事件的 WebSocket 事件发送到 Kafka
- vulcan：通过 Kafka 从 V4 节点接收链下事件，将它们归档到 PostgreSQL 数据库，并将链下事件的 WebSocket 事件发送到 Kafka
- socks：WebSocket 服务器，接受 WebSocket 通道的订阅，并将来自 Kafka 的 WebSocket 事件转发给已订阅的 WebSocket 客户端
- comlink：为 V4 索引器提供所有 HTTP API 调用服务
- roundtable：定期作业服务
- bazooka：通过 AWS Lambda 部署索引器服务

TODO(DEC-784)：为每个服务和整个单体仓库添加全面的描述/文档。

## 设置

我们在这个仓库中使用 [pnpm](https://pnpm.io/)，因为它是一个"更快且更节省磁盘空间的包管理器"，并且它在单体仓库中比 `npm` 工作得更好。

```sh
nvm install
nvm use
nvm alias default $(nvm version) # 可选
npm i -g pnpm@6
```

### 安装

现在，您可以为索引器安装依赖项。这应该在包更新时运行。

```
pnpm install
```

### 构建

要构建所有服务包，请运行：

```
pnpm run build:all
```
这应该在代码更改时运行，您需要部署或运行更新的代码，包括运行单元测试、本地部署或部署到 AWS。

## 添加包

使用 `packages/example-package` 作为模板：
```
cp -r packages/example-package packages/<package-name>
```
- 将 `package.json` 名称更新为 `@dydxprotocol-indexer/<package-name>`，更新 `README.md`，并运行 `pnpm i` 来安装依赖项。
- 在 `Dockerfile.service.local`、`Dockerfile.service.remote` 和 `Dockerfile.postgres-package.local` 中添加复制 `package.json` 文件和 `build/` 文件。
- 在 `Dockerfile.bazooka.remote` 中添加复制包目录

## 添加服务

使用 `services/example-service` 作为模板：
```
cp -r services/example-service services/<service-name>
```
- 将 `package.json` 名称更新为 `<package-name>`，更新 `README.md`，并运行 `pnpm i` 来安装依赖项。
- 在 `docker-compose-local-deployment.yml` 中添加服务部署配置。
- 将服务添加到 `v4-terraform` 仓库（TODO(DEC-838)：添加指向特定文件的链接）
- 在 `.github/workflows/build-and-push.yml` 中添加 Github action 以将镜像推送到 ECR
- 将服务添加到 Orb 以便它将被关闭、更新和重新部署
- 更新 Auxo 以部署服务

## 运行 package.json 脚本

任何服务或包的 `package.json` 脚本都可以在相应目录中使用 `pnpm run <script-name>` 运行。

注意：`pnpm` 允许使用 `-r` 标志在所有目录中运行脚本，或使用 `--parallel` 标志并行运行它们。由于我们的单元测试共享一个测试数据库，它们不能并行运行，所以不要使用任一标志。

## 协议缓冲区

协议缓冲区可以在 `proto/` 中找到，[这里](https://github.com/dydxprotocol/v4-chain/tree/main/proto)。

## 运行单元测试

首先，确保所有服务包都使用最新代码构建，运行：

```
pnpm run build:all
```

打开 2 个终端（或使用另一个 `tmux` 或 `screen` 会话）并运行：

```
# 在会话 / 终端 1 中
docker-compose up

# 在会话 / 终端 2 中
pnpm run test:all
```

如果您更改任何逻辑，您必须在运行单元测试之前重新构建服务和包。

### 运行单个测试文件：
`cd services/{service_name} && pnpm build && pnpm test -- {test_name}`

# 本地运行 Dockerfile
TODO(DEC-671)：添加端到端测试
本地部署索引器用于运行端到端测试（DEC-671）和测试来自本地 v4-protocol 部署的新消息。

## 部署

添加到您的 ~/.zshrc 文件中：
`export DD_API_KEY=<INSERT_DD_API_KEY_HERE>`

请参阅 https://app.datadoghq.com/organization-settings/api-keys 获取 API 密钥。API 密钥是"Key"，不是"Key Id"。

索引器可以在本地部署：
`docker-compose -f docker-compose-local-deployment.yml up`

如果您想将统计信息导出到 Datadog，请在上面的命令中添加以下标志：
`--profile export-to-datadog`

如果自上次本地部署索引器以来对服务进行了任何更改（例如，从主分支/新分支拉取后），请按照[重新部署](#重新部署)下的步骤操作。

注意：Kafka 容器在启动/初始化时可能会遇到问题，如果 Kafka 容器在几分钟后不健康，请按 Ctrl-C 并运行 `docker-compose -f docker-compose-local-deployment.yml down` 来删除所有容器，然后再次尝试运行 `docker-compose -f docker-compose-local-deployment.yml up`。

### 运行本地 V4 节点
默认情况下，索引器服务连接到本地 V4 节点。要在索引器旁边运行本地 V4 节点，请按照[这里](https://github.com/dydxprotocol/v4#running-the-chain-locally)的说明操作。

注意：本地 V4 节点需要在本地部署索引器之前启动。

### 连接到远程 V4 节点
要将本地部署的索引器更改为连接到远程 V4 节点，请在 `docker-compose-local-deployment.yml` 中更新 `comlink` 服务的环境变量 `TENDERMINT_WS_URL`。

例如：
```
comlink:
    build:
      dockerfile: Dockerfile.service.local
      args:
        service: comlink
    ports:
      - 3002:3002
    links:
      - postgres
    depends_on:
      postgres-package:
        condition: service_completed_successfully
```

### 部署到 AWS 开发环境
我们使用 [Terraform](https://github.com/dydxprotocol/v4-infrastructure) 来描述我们的基础设施。在合并到主分支时，我们自动为开发/暂存环境构建每个服务的 ECR 镜像（请参阅 .github/workflows 目录）。
但是，如果您想测试和部署本地更改，可以使用 `scripts/deploy-commit-to-dev.sh` 脚本。

使用示例：
scripts/deploy-commit-to-dev.sh <service> <commit_hash>，例如：
```
scripts/deploy-commit-to-dev.sh comlink 875aecd
```

您可以这样获取 7 字符的提交哈希：
```
git add .
git commit -m "<commit_msg>"
git rev-parse --short=7 HEAD
```

## 重新部署
每个容器的 docker 镜像必须为每个代码更改或 `Dockerfile.local` 的更新而重新构建。

可以单独删除镜像：
```
# 列出所有 docker 镜像
docker images
# 删除 docker 镜像
docker rmi {docker_image_id} -f
```
所有镜像都可以使用此命令删除：
```
docker rmi $(docker images 'indexer_*' -a -q) -f
```
然后可以使用上一节中的命令重新部署 docker 容器。

## 查询本地运行索引器的 API
`comlink` 将从 `http://localhost:3002` 提供 API 请求。

例如，获取所有 `BTC-USD` 交易：
```
curl http://localhost:3002/v4/trades/perpetualMarket/BTC-USD
```

## 订阅索引器的 WebSocket 消息
`socks` 将从 `http://localhost:3003` 接受 WebSocket 连接。

要连接到开发/暂存端点，请使用以下命令：
```
# 开发环境
wscli connect ws://dev-indexer-apne1-lb-public-890774175.ap-northeast-1.elb.amazonaws.com/v4/ws

# 暂存环境
wscli connect wss://indexer.v4staging.dydx.exchange/v4/ws
```

使用命令行 WebSocket 客户端（如 [interactive-websocket-cli](https://www.npmjs.com/package/interactive-websocket-cli)）连接并订阅通道。

示例（使用 `interactive-websocket-cli`）
```
wscli connect http://localhost:3003
<ws-cli 的输出>
<输入 's' 发送> { "type": "subscribe", "channel": "v4_trades", "id": "BTC-USD" }
```

其他示例订阅事件：
```
{ "type": "subscribe", "channel": "v4_candles", "id": "BTC-USD/1MIN" }
{ "type": "subscribe", "channel": "v4_markets" }
{ "type": "subscribe", "channel": "v4_orderbook", "id": "BTC-USD" }
{ "type": "subscribe", "channel": "v4_subaccounts", "id": "address/0" }
{ "type": "subscribe", "channel": "v4_block_height" }
```
